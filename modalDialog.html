<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- jQuery & DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.7/css/dataTables.dataTables.min.css" />
    <script src="https://cdn.datatables.net/2.0.7/js/dataTables.min.js"></script>

    <style>
      :root { --bg:#ffffff; --fg:#303030; --brand:#cf2e2e; }
      body { font-family: Arial, sans-serif; margin:0; padding:12px; background-color: var(--bg); color: var(--fg); }
      h1 { text-align:center; font-size:18px; color:var(--fg); margin:0 0 8px; }

      .card { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:12px; }

      .loader { border:3px solid #f3f3f3; border-top:3px solid var(--brand); width:24px; height:24px; border-radius:50%; animation: spin 1s linear infinite; display:none; }
      @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

      /* DataTables tweaks */
      div.dataTables_filter {
        margin-bottom: 10px;
      }
      div.dataTables_filter label {
        font-size: 14px;
        color: #333;
      }
      div.dataTables_filter input {
        border-radius: 20px;
        border: 1px solid #ccc;
        padding: 6px 12px;
        font-size: 13px;
        outline: none;
        transition: all 0.2s ease-in-out;
      }
      div.dataTables_filter input:focus {
        border-color: var(--brand);
        box-shadow: 0 0 4px rgba(76, 175, 80, 0.4);
      }

      table.dataTable { width:100% !important; border-collapse: collapse; }
      table.dataTable thead th { background-color: var(--brand); color:#fff; }
      table.dataTable tbody tr:nth-child(even) { background-color:#fafafa; }
      table.dataTable tbody tr:hover { background:#eee; }
      table.dataTable td, table.dataTable th { padding:8px 10px; font-size:12px; }
      /* Modern search bar (DataTables v2 + v1 fallback) */
      .dt-container { width: 100%; }
      .dt-search { width: 100%; margin-bottom: 8px; }
      .dt-search input,
      .dataTables_filter input { width: 100%; border: 1px solid #ddd; border-radius: 24px; padding: 10px 14px; font-size: 14px; outline: none; box-shadow: inset 0 1px 2px rgba(0,0,0,.05); }
      .dt-search label, .dataTables_filter label { width: 100%; display: block; }

      /* Make the table adapt to its container */
      #resultTable { width: 100% !important; table-layout: auto; }
      .card { overflow: auto; }

      /* Adjust header look */
      table.dataTable thead th { white-space: nowrap; }

      @media (max-width: 640px) {
        .dt-search input, .dataTables_filter input { font-size: 13px; }
      }
    </style>
  </head>
  <body>
    <h1>BuscadorAAARBA</h1>

    <!-- Loader de carga inicial -->
    <div class="card" id="loading-box" style="display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:10px;">
      <div class="loader" id="loader"></div>
      <span id="loading-text" style="color:#666; font-size:12px;">Cargando datosâ€¦</span>
    </div>

    <!-- Tabla de resultados -->
    <div class="card">
      <table id="resultTable" class="display" style="width:100%">
        <thead>
          <tr></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="no-results" style="display:none; padding:8px; text-align:center; color:#666;">No se encontraron resultados.</div>
    </div>

    <script>
  let dt = null;

  function loadAll() {
    const loader = document.getElementById('loader');
    const loadingText = document.getElementById('loading-text');
    if (loader) loader.style.display = 'inline-block';
    if (loadingText) loadingText.style.display = 'inline-block';
    google.script.run.withSuccessHandler(displayResults).searchDatabase('');
  }

  function displayResults(results) {
    const loader = document.getElementById('loader');
    const loadingText = document.getElementById('loading-text');
    const loadingBox = document.getElementById('loading-box');

    // ðŸ”¹ Ocultar el loader apenas se cargan los resultados
    if (loader) loader.style.display = 'none';
    if (loadingText) loadingText.style.display = 'none';
    if (loadingBox) loadingBox.style.display = 'none';

    const table = document.getElementById('resultTable');
    const theadRow = table.querySelector('thead tr');
    const tbody = table.querySelector('tbody');
    const noResults = document.getElementById('no-results');

    theadRow.innerHTML = '';
    tbody.innerHTML = '';

    if (!results || results.length < 2) {
      if (dt) { dt.destroy(); dt = null; }
      noResults.style.display = 'block';
      return;
    }
    noResults.style.display = 'none';

    // ðŸ”¹ Columnas: CÃ³digo (B=1), Nivel (C=2), DescripciÃ³n (D=3) y Ã“rgano (A=0)
    const cols = [1, 2, 3, 0];
    const headers = ["CÃ³digo", "Nivel", "DescripciÃ³n", "Ã“rgano"];

    // Crear encabezados
    headers.forEach((title, index) => {
      const th = document.createElement('th');
      th.textContent = title;
      theadRow.appendChild(th);
    });

    // Crear filas
    for (let i = 1; i < results.length; i++) {
      const tr = document.createElement('tr');
      cols.forEach(col => {
        const td = document.createElement('td');
        td.textContent = (results[i][col] ?? '').toString();
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }

    if (dt) { dt.destroy(); }
    dt = new DataTable('#resultTable', {
      paging: false,
      info: false,
      lengthChange: false,
      searching: true,
      ordering: true,
      responsive: true,
      language: {
        search: "Buscar:",
        zeroRecords: "No se encontraron registros coincidentes"
      },
      dom: 'ft',
      scrollX: true,
      autoWidth: false
    });
  }

  document.addEventListener('DOMContentLoaded', loadAll);
</script>
  </body>
</html>
